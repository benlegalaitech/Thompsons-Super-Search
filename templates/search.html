{% extends "base.html" %}

{% block title %}Search - {{ project.name }} - Super Search{% endblock %}

{% block content %}
<div class="search-container">
    <h1>{{ project.name }}</h1>
    <p class="subtitle">Search across {{ metadata.total_docs | default(0) }} documents &mdash; {{ metadata.get('pdf_docs', 0) }} PDFs, {{ metadata.get('excel_docs', 0) }} Excel files</p>

    <div class="search-section">
        <form class="search-form" id="searchForm">
            <input type="text" name="q" id="searchInput" placeholder="Ask a question or enter search terms..." autocomplete="off">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <!-- Search Mode Toggle -->
        <div class="search-mode-toggle" id="searchModeToggle">
            <button class="mode-btn active" data-mode="smart" id="modeSmartBtn">
                <span class="mode-icon">&#x1F9E0;</span> Smart Search
            </button>
            <button class="mode-btn" data-mode="keyword" id="modeKeywordBtn">
                <span class="mode-icon">&#x1F524;</span> Keyword Search
            </button>
        </div>

        <div class="filter-bar">
            <span class="filter-label">Filter:</span>
            <button class="filter-btn active" data-type="" id="filterAll">All</button>
            <button class="filter-btn" data-type="pdf" id="filterPdf"><span class="file-type-badge pdf" style="margin-right:4px;font-size:0.7em;">PDF</span>PDFs</button>
            <button class="filter-btn" data-type="excel" id="filterExcel"><span class="file-type-badge excel" style="margin-right:4px;font-size:0.7em;">XLSX</span>Excel</button>
        </div>

        <p class="search-hint" id="searchHint">
            <span id="smartHint">Ask natural language questions like "documents about asbestos mentioning John"</span>
            <span id="keywordHint" style="display:none">Multiple words = AND search. Use "quotes" for exact phrases.</span>
        </p>
    </div>

    <!-- Query Interpretation Box (shown after smart search) -->
    <div class="interpretation-box" id="interpretationBox" style="display:none">
        <div class="interpretation-header">
            <strong>Understood as:</strong>
            <span id="interpretationText"></span>
        </div>
        <details class="interpretation-details">
            <summary>Search details</summary>
            <div id="queryPlanDetails"></div>
        </details>
    </div>

    <div id="results">
        {% if metadata.loading %}
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>{{ metadata.loading_message | default('Loading index...') }}</p>
            <p class="search-hint">This page will auto-refresh when ready.</p>
        </div>
        {% else %}
        <div class="empty-state">
            <h2>Enter a search term</h2>
            <p>Type keywords or ask a question to search across all documents</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROJECT_ID = '{{ project.id }}';
const INDEX_LOADING = {{ 'true' if metadata.loading else 'false' }};

// Search configuration
let searchConfig = {
    smart_search_enabled: true,
    keyword_search_enabled: true,
    default_mode: 'smart'
};

// Current state
let currentSearchMode = 'smart';
let currentPage = 1;
let currentQuery = '';
let currentFileType = '';

// Auto-refresh when index is loading
if (INDEX_LOADING) {
    setTimeout(() => {
        fetch(`/p/${PROJECT_ID}/api/stats`)
            .then(r => r.json())
            .then(data => {
                if (!data.loading) {
                    window.location.reload();
                } else {
                    setTimeout(() => window.location.reload(), 3000);
                }
            })
            .catch(() => setTimeout(() => window.location.reload(), 3000));
    }, 3000);
}

// Load search configuration
fetch(`/p/${PROJECT_ID}/api/search-config`)
    .then(r => r.json())
    .then(config => {
        searchConfig = config;
        currentSearchMode = config.default_mode;
        updateModeUI();

        // Hide toggle if only one mode is available
        if (!config.smart_search_enabled || !config.keyword_search_enabled) {
            document.getElementById('searchModeToggle').style.display = 'none';
        }
    })
    .catch(() => {
        // Default to keyword if config fails
        currentSearchMode = 'keyword';
        updateModeUI();
    });

const searchForm = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
const resultsDiv = document.getElementById('results');
const interpretationBox = document.getElementById('interpretationBox');
const interpretationText = document.getElementById('interpretationText');
const queryPlanDetails = document.getElementById('queryPlanDetails');

// Search mode toggle
document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const mode = this.dataset.mode;
        if (mode === 'smart' && !searchConfig.smart_search_enabled) return;
        if (mode === 'keyword' && !searchConfig.keyword_search_enabled) return;

        currentSearchMode = mode;
        updateModeUI();

        // Re-search if there's a query
        if (currentQuery) {
            currentPage = 1;
            performSearch();
        }
    });
});

function updateModeUI() {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector(`.mode-btn[data-mode="${currentSearchMode}"]`);
    if (activeBtn) activeBtn.classList.add('active');

    // Update hint text
    document.getElementById('smartHint').style.display = currentSearchMode === 'smart' ? 'inline' : 'none';
    document.getElementById('keywordHint').style.display = currentSearchMode === 'keyword' ? 'inline' : 'none';

    // Update placeholder
    if (currentSearchMode === 'smart') {
        searchInput.placeholder = 'Ask a question or enter search terms...';
    } else {
        searchInput.placeholder = 'Enter search terms...';
    }

    // Hide interpretation box when switching modes
    interpretationBox.style.display = 'none';
}

searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    currentQuery = searchInput.value.trim();
    if (currentQuery) {
        performSearch();
    }
});

// File type filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFileType = this.dataset.type;
        if (currentQuery) {
            currentPage = 1;
            performSearch();
        }
    });
});

function performSearch() {
    if (!currentQuery) return;

    // Hide interpretation box during search
    interpretationBox.style.display = 'none';

    if (currentSearchMode === 'smart') {
        performSmartSearch();
    } else {
        performKeywordSearch();
    }
}

function performSmartSearch() {
    resultsDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Analyzing your query...</p>
            <p class="search-hint">Using AI to understand your search</p>
        </div>
    `;

    fetch(`/p/${PROJECT_ID}/api/smart-search`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            query: currentQuery,
            page: currentPage,
            type: currentFileType
        })
    })
    .then(response => response.json().then(data => ({ ok: response.ok, data })))
    .then(({ ok, data }) => {
        if (!ok) {
            // Handle error response
            let errorHtml = `
                <div class="search-error">
                    <h3>Search Error</h3>
                    <p>${escapeHtml(data.error || 'An error occurred')}</p>
            `;

            if (data.fallback_available) {
                errorHtml += `
                    <p><button class="btn btn-secondary" onclick="switchToKeywordAndSearch()">Try Keyword Search</button></p>
                `;
            }

            errorHtml += '</div>';
            resultsDiv.innerHTML = errorHtml;
            return;
        }

        // Show interpretation
        if (data.interpretation) {
            interpretationText.textContent = data.interpretation;
            interpretationBox.style.display = 'block';

            // Show query plan details
            if (data.query_plan) {
                let detailsHtml = '<ul>';
                if (data.query_plan.required_terms?.length) {
                    detailsHtml += `<li><strong>Required terms:</strong> ${data.query_plan.required_terms.join(', ')}</li>`;
                }
                if (data.query_plan.optional_terms?.length) {
                    detailsHtml += `<li><strong>Related terms:</strong> ${data.query_plan.optional_terms.join(', ')}</li>`;
                }
                if (data.query_plan.person_names?.length) {
                    detailsHtml += `<li><strong>Person names:</strong> ${data.query_plan.person_names.join(', ')}</li>`;
                }
                if (data.query_plan.locations?.length) {
                    detailsHtml += `<li><strong>Locations:</strong> ${data.query_plan.locations.join(', ')}</li>`;
                }
                detailsHtml += `<li><strong>Confidence:</strong> ${Math.round(data.query_plan.confidence * 100)}%</li>`;
                if (data.llm_latency_ms) {
                    detailsHtml += `<li><strong>Query time:</strong> ${data.llm_latency_ms}ms${data.cache_hit ? ' (cached)' : ''}</li>`;
                }
                detailsHtml += '</ul>';
                queryPlanDetails.innerHTML = detailsHtml;
            }
        }

        // Show warning if present
        if (data.warning) {
            interpretationBox.classList.add('has-warning');
            interpretationText.innerHTML += ` <span class="warning-badge">${escapeHtml(data.warning)}</span>`;
        } else {
            interpretationBox.classList.remove('has-warning');
        }

        renderResults(data);
    })
    .catch(error => {
        console.error('Smart search error:', error);
        resultsDiv.innerHTML = `
            <div class="search-error">
                <h3>Search Error</h3>
                <p>An error occurred while searching. Please try again.</p>
                <p><button class="btn btn-secondary" onclick="switchToKeywordAndSearch()">Try Keyword Search</button></p>
            </div>
        `;
    });
}

function performKeywordSearch() {
    resultsDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Searching...</p>
        </div>
    `;

    const typeParam = currentFileType ? `&type=${currentFileType}` : '';
    fetch(`/p/${PROJECT_ID}/api/search?q=${encodeURIComponent(currentQuery)}&page=${currentPage}${typeParam}`)
        .then(response => response.json())
        .then(data => {
            renderResults(data);
        })
        .catch(error => {
            resultsDiv.innerHTML = `
                <div class="no-results">
                    <h3>Error</h3>
                    <p>An error occurred while searching. Please try again.</p>
                </div>
            `;
            console.error('Search error:', error);
        });
}

function switchToKeywordAndSearch() {
    currentSearchMode = 'keyword';
    updateModeUI();
    performSearch();
}

function renderResults(data) {
    if (data.total_matches === 0) {
        let noResultsHtml = `
            <div class="no-results">
                <h3>No results found</h3>
                <p>No documents match your search</p>
        `;

        // Suggest switching modes if no results
        if (currentSearchMode === 'smart' && searchConfig.keyword_search_enabled) {
            noResultsHtml += `<p><button class="btn btn-secondary" onclick="switchToKeywordAndSearch()">Try Keyword Search</button></p>`;
        } else if (currentSearchMode === 'keyword' && searchConfig.smart_search_enabled) {
            noResultsHtml += `<p><button class="btn btn-secondary" onclick="switchToSmartAndSearch()">Try Smart Search</button></p>`;
        }

        noResultsHtml += '</div>';
        resultsDiv.innerHTML = noResultsHtml;
        return;
    }

    let html = `
        <div class="stats-bar">
            <span>Found <span class="count">${data.total_matches}</span> matches across <span class="count">${data.documents}</span> documents</span>
            <span class="search-mode-indicator">${currentSearchMode === 'smart' ? 'Smart Search' : 'Keyword Search'}</span>
            <span>Page ${data.page}</span>
        </div>
        <div class="results-section">
    `;

    for (const result of data.results) {
        const fileType = result.file_type || 'pdf';
        let fileUrl, linkTitle, locationLabel, typeBadge;

        // Build the query string - use original query for highlighting
        const queryForHighlight = encodeURIComponent(currentQuery);

        if (fileType === 'excel') {
            fileUrl = `/p/${PROJECT_ID}/excel-view/${result.filepath}?sheet=${encodeURIComponent(result.sheet_name || '')}&q=${queryForHighlight}`;
            linkTitle = `Click to view Excel sheet: ${result.sheet_name || 'Sheet ' + result.page}`;
            locationLabel = result.sheet_name ? `Sheet: ${escapeHtml(result.sheet_name)}` : `Sheet ${result.page}`;
            typeBadge = '<span class="file-type-badge excel">XLSX</span>';
        } else if (fileType === 'word') {
            fileUrl = `/p/${PROJECT_ID}/doc-view/${result.filepath}?q=${queryForHighlight}`;
            linkTitle = `Click to view document`;
            locationLabel = 'Document';
            typeBadge = '<span class="file-type-badge word">DOC</span>';
        } else if (fileType === 'email') {
            fileUrl = `/p/${PROJECT_ID}/doc-view/${result.filepath}?q=${queryForHighlight}`;
            linkTitle = `Click to view email`;
            locationLabel = 'Email';
            typeBadge = '<span class="file-type-badge email">EMAIL</span>';
        } else {
            fileUrl = `/p/${PROJECT_ID}/pdf/${result.filepath}#page=${result.page}`;
            linkTitle = `Click to open PDF at page ${result.page}`;
            locationLabel = `Page ${result.page}`;
            typeBadge = '<span class="file-type-badge pdf">PDF</span>';
        }

        html += `
            <div class="result-item">
                <div class="result-header">
                    <div class="result-title-row">
                        ${typeBadge}
                        <a href="${fileUrl}" target="_blank" class="result-filename" title="${linkTitle}">${escapeHtml(result.filename)}</a>
                    </div>
                    <span class="result-page">${locationLabel}</span>
                </div>
                <div class="result-path">${escapeHtml(result.filepath)}</div>
                <div class="result-context">${result.context}</div>
            </div>
        `;
    }

    html += '</div>';

    // Pagination
    if (data.total_pages > 1) {
        html += `
            <div class="pagination">
                <button class="btn btn-secondary" ${data.page <= 1 ? 'disabled' : ''} onclick="prevPage()">Previous</button>
                <span class="page-info">Page ${data.page} of ${data.total_pages}</span>
                <button class="btn btn-secondary" ${!data.has_more ? 'disabled' : ''} onclick="nextPage()">Next</button>
            </div>
        `;
    }

    resultsDiv.innerHTML = html;
}

function switchToSmartAndSearch() {
    currentSearchMode = 'smart';
    updateModeUI();
    performSearch();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        performSearch();
    }
}

function nextPage() {
    currentPage++;
    performSearch();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Focus search input on load
searchInput.focus();
</script>
{% endblock %}
