{% extends "base.html" %}

{% block title %}Search - {{ project.name }} - Super Search{% endblock %}

{% block content %}
<div class="search-container">
    <h1>{{ project.name }}</h1>
    <p class="subtitle">Search across {{ metadata.total_docs | default(0) }} documents &mdash; {{ metadata.get('pdf_docs', 0) }} PDFs, {{ metadata.get('excel_docs', 0) }} Excel files</p>

    <div class="search-section">
        <form class="search-form" id="searchForm">
            <input type="text" name="q" id="searchInput" placeholder="Enter search terms..." autocomplete="off">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <div class="filter-bar">
            <span class="filter-label">Filter:</span>
            <button class="filter-btn active" data-type="" id="filterAll">All</button>
            <button class="filter-btn" data-type="pdf" id="filterPdf"><span class="file-type-badge pdf" style="margin-right:4px;font-size:0.7em;">PDF</span>PDFs</button>
            <button class="filter-btn" data-type="excel" id="filterExcel"><span class="file-type-badge excel" style="margin-right:4px;font-size:0.7em;">XLSX</span>Excel</button>
        </div>
        <p class="search-hint">Multiple words = AND search. Use "quotes" for exact phrases.</p>
    </div>

    <div id="results">
        <div class="empty-state">
            <h2>Enter a search term</h2>
            <p>Type keywords to search across all documents</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROJECT_ID = '{{ project.id }}';
const searchForm = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
const resultsDiv = document.getElementById('results');
let currentPage = 1;
let currentQuery = '';
let currentFileType = '';

searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    currentQuery = searchInput.value.trim();
    if (currentQuery) {
        performSearch();
    }
});

// File type filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFileType = this.dataset.type;
        if (currentQuery) {
            currentPage = 1;
            performSearch();
        }
    });
});

function performSearch() {
    if (!currentQuery) return;

    resultsDiv.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Searching...</p>
        </div>
    `;

    const typeParam = currentFileType ? `&type=${currentFileType}` : '';
    fetch(`/p/${PROJECT_ID}/api/search?q=${encodeURIComponent(currentQuery)}&page=${currentPage}${typeParam}`)
        .then(response => response.json())
        .then(data => {
            renderResults(data);
        })
        .catch(error => {
            resultsDiv.innerHTML = `
                <div class="no-results">
                    <h3>Error</h3>
                    <p>An error occurred while searching. Please try again.</p>
                </div>
            `;
            console.error('Search error:', error);
        });
}

function renderResults(data) {
    if (data.total_matches === 0) {
        resultsDiv.innerHTML = `
            <div class="no-results">
                <h3>No results found</h3>
                <p>No documents match "${escapeHtml(data.query)}"</p>
            </div>
        `;
        return;
    }

    let html = `
        <div class="stats-bar">
            <span>Found <span class="count">${data.total_matches}</span> matches across <span class="count">${data.documents}</span> documents</span>
            <span>Page ${data.page}</span>
        </div>
        <div class="results-section">
    `;

    for (const result of data.results) {
        const isExcel = result.file_type === 'excel';
        let fileUrl, linkTitle, locationLabel, typeBadge;

        if (isExcel) {
            fileUrl = `/p/${PROJECT_ID}/excel-view/${result.filepath}?sheet=${encodeURIComponent(result.sheet_name || '')}&q=${encodeURIComponent(data.query)}`;
            linkTitle = `Click to view Excel sheet: ${result.sheet_name || 'Sheet ' + result.page}`;
            locationLabel = result.sheet_name ? `Sheet: ${escapeHtml(result.sheet_name)}` : `Sheet ${result.page}`;
            typeBadge = '<span class="file-type-badge excel">XLSX</span>';
        } else {
            fileUrl = `/p/${PROJECT_ID}/pdf/${result.filepath}#page=${result.page}`;
            linkTitle = `Click to open PDF at page ${result.page}`;
            locationLabel = `Page ${result.page}`;
            typeBadge = '<span class="file-type-badge pdf">PDF</span>';
        }

        html += `
            <div class="result-item">
                <div class="result-header">
                    <div class="result-title-row">
                        ${typeBadge}
                        <a href="${fileUrl}" target="_blank" class="result-filename" title="${linkTitle}">${escapeHtml(result.filename)}</a>
                    </div>
                    <span class="result-page">${locationLabel}</span>
                </div>
                <div class="result-path">${escapeHtml(result.filepath)}</div>
                <div class="result-context">${result.context}</div>
            </div>
        `;
    }

    html += '</div>';

    // Pagination
    if (data.total_pages > 1) {
        html += `
            <div class="pagination">
                <button class="btn btn-secondary" ${data.page <= 1 ? 'disabled' : ''} onclick="prevPage()">Previous</button>
                <span class="page-info">Page ${data.page} of ${data.total_pages}</span>
                <button class="btn btn-secondary" ${!data.has_more ? 'disabled' : ''} onclick="nextPage()">Next</button>
            </div>
        `;
    }

    resultsDiv.innerHTML = html;
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        performSearch();
    }
}

function nextPage() {
    currentPage++;
    performSearch();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Focus search input on load
searchInput.focus();
</script>
{% endblock %}
